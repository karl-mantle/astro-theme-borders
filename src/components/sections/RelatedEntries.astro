---
import type { DataEntryMap } from 'astro:content';
import type { SectionProps } from '../../types';
import { PERMALINK_POSTS_SINGLE, PERMALINK_CUSTOM_SINGLE, PERMALINK_POSTS_CATEGORY, PERMALINK_CUSTOM_CATEGORY } from '../../consts';
import { slugify, getEntriesByCategory } from '../../utils';
import Container from './Container.astro';
import PostCard from '../cards/Post.astro';
import CustomCard from '../cards/Post.astro';

interface Props extends SectionProps {
  columns: number,
  contentCollection: keyof DataEntryMap,
  maxEntries?: number,
  category: string
};

const { title, titleTag = 'h2', description, primaryButtonProps, secondaryButtonProps, columns, contentCollection, category, maxEntries = 3, class: className, ...rest }: Partial<Props> = Astro.props;

const entries = await getEntriesByCategory(contentCollection, category, maxEntries);

let defaultTitle;
switch (contentCollection) {
  case 'posts':
    defaultTitle = 'Related posts'
    break;
  case 'custom':
    defaultTitle = 'Related custom'
    break;
  default:
    defaultTitle = 'Lorem ipsum dolor sit amet'
    break;
};

let defaultHref;
switch (contentCollection) {
  case 'posts':
    defaultHref = `${Astro.site}${PERMALINK_POSTS_CATEGORY}/${slugify(category)}`;
    break;
  case 'custom':
    defaultHref = `${Astro.site}${PERMALINK_CUSTOM_CATEGORY}/${slugify(category)}`;
    break;
  default:
    defaultHref = '404';
    break;
};
---

<Container
  columns={columns}
  title={title || defaultTitle }
  titleTag={titleTag}
  description={description}
  primaryButtonProps={primaryButtonProps || { buttonStyle: 'link', href: `${defaultHref}`, text: `View more ${String(contentCollection)}`, textClass: '', icon: 'tabler:arrow-right', iconSize: 21, iconReverse: false, iconRotate: true, ariaLabel: `open ${category} ${String(contentCollection)} archive` }}
  secondaryButtonProps={secondaryButtonProps}
  class={className}
  {...rest}
>

  { contentCollection === 'posts' && (
    entries.map((post) =>
      <PostCard
        title={post.data.title}
        titleTag="h3"
        description={post.data.description}
        date={post.data.pubDate}
        image={post.data.image?.src}
        alt={post.data.image?.alt}
        href={`${Astro.site}${PERMALINK_POSTS_SINGLE}${post.data.slug}/`}
      />
    )
  )}

  { contentCollection === 'custom' && (
    entries.map((custom) =>
      <CustomCard
        title={custom.data.title}
        titleTag="h3"
        description={custom.data.description}
        date={custom.data.pubDate}
        image={custom.data.image?.src}
        alt={custom.data.image?.alt}
        href={`${Astro.site}${PERMALINK_CUSTOM_SINGLE}${custom.data.slug}/`}
      />
    )
  )}

</Container>
